<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indented Tree View</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .node {
            cursor: pointer;
            padding: 5px;
        }
        .indent {
            margin-left: 20px;
        }
    </style>
</head>
<body>
    <h1>Hierarchy</h1>
    <div id="tree-container"></div>

    <script>
        fetch("/hierarchy")
            .then(response => response.json())
            .then(data => {
                const root = buildTree(data);
                initializeCollapse(root); // Collapse initially
                renderTree(root);
            })
            .catch(error => console.error("Error fetching data:", error));

        function buildTree(data) {
            let nodeMap = new Map();

            // Initialize nodes
            data.forEach(node => {
                node.children = [];
                node.expanded = false; // Start collapsed
                nodeMap.set(node.ID, node);
            });

            let root = null;

            // Build hierarchy
            data.forEach(node => {
                if (node.Upline === null) {
                    root = node;
                } else {
                    let parent = nodeMap.get(node.Upline);
                    if (parent) {
                        parent.children.push(node);
                    }
                }
            });

            return root;
        }

        function initializeCollapse(node) {
            if (node.children.length > 0) {
                node.children.forEach(initializeCollapse);
            }
        }

        function renderTree(root) {
            const container = d3.select("#tree-container");
            container.html(""); // Clear previous content

            function renderNode(node, depth = 0) {
                const row = container.append("div")
                    .attr("class", "node indent")
                    .style("margin-left", `${depth * 20}px`)
                    .text(node.expanded ? "▼ " + node.Value : "▶ " + node.Value)
                    .on("click", function () {
                        node.expanded = !node.expanded;
                        renderTree(root);
                    });

                if (node.expanded) {
                    node.children.forEach(child => renderNode(child, depth + 1));
                }
            }

            renderNode(root);
        }
    </script>
</body>
</html>
